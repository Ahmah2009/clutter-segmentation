<launch>

  <group ns="vfh_estimation">
    <node pkg="nodelet" type="nodelet" name="vfh_manager" args="manager" output="screen" />

    <!-- Run a passthrough filter to clean NaNs -->
    <node pkg="nodelet" type="nodelet" name="passthrough" args="load pcl/VoxelGrid vfh_manager" output="screen">
      <remap from="~input" to="/points2" />
      <rosparam>
        leaf_size: 0.001
        filter_field_name: z
        filter_limit_min: 0.5
        filter_limit_max: 1.5
      </rosparam>
    </node>

    <!-- Extract the object clusters using a polygonal prism -->
    <node pkg="nodelet" type="nodelet" name="extract_data_indices" args="load pcl/ExtractPolygonalPrismData vfh_manager" output="screen">
      <remap from="~input"         to="passthrough/output" />
      <remap from="~planar_hull"   to="/ptu/table_hull" />
      <rosparam>
        height_min: 0.02
        height_max: 0.2
        approximate_sync: true
        max_queue_size: 50
      </rosparam>
    </node>

    <node pkg="nodelet" type="nodelet" name="extract_data" args="load pcl/ExtractIndices vfh_manager" output="screen">
      <remap from="~input"   to="passthrough/output" />
      <remap from="~indices" to="extract_data_indices/output" />
      <rosparam>
        negative: false
      </rosparam>
    </node>

    <!-- Estimate surface normals -->
    <node pkg="nodelet" type="nodelet" name="extract_normals" args="load pcl/NormalEstimation vfh_manager" output="screen">
      <remap from="~input" to="extract_data/output" />
      <rosparam>
        k_search: 30
        radius_search: 0
        spatial_locator: 0
     </rosparam>
    </node>

    <!-- Estimate VFH signatures, and write them to disk -->
    <node pkg="nodelet" type="nodelet" name="VFH_estimation" args="load pcl/VFHEstimation vfh_manager" output="screen">
      <remap from="~input"   to="extract_data/output" />
      <remap from="~normals" to="extract_normals/output" />
      <rosparam>
        k_search: 1
        spatial_locator: 0
     </rosparam>
    </node>

  <node pkg="nodelet" type="nodelet" name="WriterVFH" args="load pcl/PCDWriter vfh_manager" output="screen">
   <remap from="~input" to="VFH_estimation/output" />
   <rosparam>
     prefix: vfh_
     binary_mode: False
   </rosparam>
  </node>

  <!-- Concatenate data and write surface normals to disk as PCD for visualization -->
  <node pkg="nodelet" type="nodelet" name="MUXNormals" args="load pcl/NodeletMUX vfh_manager" output="screen">
    <rosparam>
      input_topics: [/vfh_estimation/extract_data/output, /vfh_estimation/extract_normals/output]
      max_queue_size: 20
   </rosparam>
  </node>
  <node pkg="nodelet" type="nodelet" name="ConcatenateNormals" args="load pcl/PointCloudConcatenateFieldsSynchronizer vfh_manager" output="screen">
   <remap from="~input" to="MUXNormals/output" />
   <rosparam>
     input_messages: 2
     max_queue_size: 20
   </rosparam>
  </node>
  <node pkg="nodelet" type="nodelet" name="WriterNormals" args="load pcl/PCDWriter vfh_manager" output="screen">
   <remap from="~input" to="ConcatenateNormals/output" />
   <rosparam>
     prefix: nxyz_
     binary_mode: True
   </rosparam>
  </node>
  </group>

</launch>

